apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: works.nereid.yuiseki.net
spec:
  group: nereid.yuiseki.net
  scope: Namespaced
  names:
    plural: works
    singular: work
    kind: Work
    shortNames:
      - nw
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          required: ["spec"]
          properties:
            spec:
              type: object
              required: ["kind", "title"]
              properties:
                grantRef:
                  type: object
                  properties:
                    name:
                      type: string
                  required: ["name"]
                kind:
                  type: string
                  enum:
                    - overpassql.map.v1
                    - maplibre.style.v1
                    - duckdb.map.v1
                    - gdal.rastertile.v1
                    - laz.3dtiles.v1
                title:
                  type: string
                overpass:
                  type: object
                  required: ["endpoint", "query"]
                  properties:
                    endpoint:
                      type: string
                    query:
                      type: string
                style:
                  type: object
                  properties:
                    sourceStyle:
                      type: object
                      properties:
                        mode:
                          type: string
                          enum: ["inline", "url"]
                        json:
                          type: string
                        url:
                          type: string
                    validate:
                      type: boolean
                duckdb:
                  type: object
                  properties:
                    input:
                      type: object
                      properties:
                        uri:
                          type: string
                        format:
                          type: string
                    sql:
                      type: string
                    output:
                      type: object
                      properties:
                        geometry:
                          type: object
                          properties:
                            mode:
                              type: string
                            lonColumn:
                              type: string
                            latColumn:
                              type: string
                raster:
                  type: object
                  properties:
                    input:
                      type: object
                      properties:
                        uri:
                          type: string
                    nodata:
                      type: object
                      properties:
                        src:
                          type: string
                        dst:
                          type: string
                    reprojection:
                      type: object
                      properties:
                        targetSRS:
                          type: string
                        targetEPSG:
                          type: string
                        resampling:
                          type: string
                    tiles:
                      type: object
                      properties:
                        minZoom:
                          type: integer
                        maxZoom:
                          type: integer
                pointcloud:
                  type: object
                  properties:
                    input:
                      type: object
                      properties:
                        uri:
                          type: string
                    crs:
                      type: object
                      properties:
                        source:
                          type: string
                        target:
                          type: string
                        inAxisOrdering:
                          type: string
                        outAxisOrdering:
                          type: string
                    py3dtiles:
                      type: object
                      properties:
                        jobs:
                          type: integer
                        pyprojAlwaysXY:
                          type: boolean
                render:
                  type: object
                  properties:
                    viewport:
                      type: object
                      properties:
                        center:
                          type: array
                          items: { type: number }
                          minItems: 2
                          maxItems: 2
                        zoom:
                          type: number
                    baseStyle:
                      type: object
                      properties:
                        type:
                          type: string
                        tiles:
                          type: array
                          items:
                            type: string
                        tileSize:
                          type: integer
                constraints:
                  type: object
                  properties:
                    deadlineSeconds:
                      type: integer
                      minimum: 1
                      maximum: 86400
                    egress:
                      type: object
                      properties:
                        mode:
                          type: string
                          enum: ["deny", "allowlist"]
                        allowlist:
                          type: array
                          items: { type: string }
                artifacts:
                  type: object
                  properties:
                    layout:
                      type: string
            status:
              type: object
              properties:
                phase:
                  type: string
                message:
                  type: string
                artifactUrl:
                  type: string
